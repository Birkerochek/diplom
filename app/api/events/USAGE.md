## Общая информация

- Все эндпоинты требуют авторизованного пользователя через `next-auth`.
- Ответы и ошибки возвращаются в формате JSON. Стандартная структура ошибки: `{ "message": string }`.
- Все даты и время выдаются в формате ISO 8601 (UTC).
- Полный префикс: `/api/events`.

## GET /api/events

### Назначение
Получение списка мероприятий с фильтрами, сортировкой, пагинацией и аналитикой.

### Доступ
- `organizer`: только мероприятия текущего организатора, доступны все статусы.
- `volunteer`: доступ к мероприятиям со статусами `published`, `active`, `completed`.

### Параметры запроса

| Параметр      | Тип      | Описание                                                                 |
|---------------|----------|--------------------------------------------------------------------------|
| `page`        | number   | Номер страницы (>=1). По умолчанию `1`.                                  |
| `perPage`     | number   | Размер страницы (1–50). По умолчанию `12`.                                |
| `sortBy`      | string   | Поле сортировки: `eventDate`, `createdAt`, `updatedAt`, `title`, `status`.|
| `sortDir`     | string   | Направление сортировки: `asc` (по умолчанию) или `desc`.                 |
| `status`      | string   | Список статусов через запятую. Неподдерживаемые значения игнорируются.   |
| `search`      | string   | Поиск по названию, описанию, локации и направлению.                       |
| `dateFrom`    | ISO date | Нижняя граница даты (включительно).                                      |
| `dateTo`      | ISO date | Верхняя граница даты (включительно).                                     |
| `organizerId` | string   | Фильтр по организатору (доступен только роли `volunteer`).               |

### Пример запроса

```
GET /api/events?page=1&perPage=6&status=active,completed&search=парк
```

### Пример ответа

```json
{
  "data": [
    {
      "id": "32d3d95f-...",
      "title": "Уборка парка",
      "description": "Чистим городскую зону",
      "status": "active",
      "activityType": "Экология",
      "schedule": {
        "eventDate": "2025-01-25T00:00:00.000Z",
        "startTime": "2025-01-25T06:00:00.000Z",
        "endTime": "2025-01-25T10:00:00.000Z",
        "requiredHours": 4
      },
      "location": { "name": "Центральный парк", "address": "ул. Победы, 1" },
      "capacity": {
        "maxParticipants": 20,
        "currentParticipants": 12,
        "confirmedParticipants": 15,
        "fillRate": 75
      },
      "stats": {
        "registrations": {
          "pending": 1,
          "approved": 14,
          "rejected": 0,
          "cancelled": 0,
          "completed": 1,
          "total": 16
        },
        "volunteerHours": 64
      },
      "organizer": { "id": "b1e3...", "name": "Иван", "email": "ivan@example.com" },
      "tags": [],
      "timestamps": {
        "createdAt": "2024-12-01T12:00:00.000Z",
        "updatedAt": "2024-12-05T09:30:00.000Z",
        "publishedAt": "2024-12-02T10:00:00.000Z"
      }
    }
  ],
  "meta": {
    "page": 1,
    "perPage": 6,
    "total": 34,
    "totalPages": 6,
    "sort": { "field": "eventDate", "direction": "asc" },
    "filters": {
      "status": "active,completed",
      "search": "парк",
      "dateFrom": null,
      "dateTo": null,
      "organizerId": null
    }
  },
  "summary": {
    "byStatus": [
      { "status": "active", "count": 12 },
      { "status": "completed", "count": 8 }
    ],
    "byActivityType": [
      { "activityType": "Экология", "count": 5 },
      { "activityType": "Социальная помощь", "count": 7 }
    ]
  }
}
```

### Возможные ошибки
- `401` — пользователь не авторизован.
- `403` — роль не поддерживается.
- `500` — внутренняя ошибка сервера.

## POST /api/events

### Назначение
Создание мероприятия. Валидируется `eventCreateSchema` из `@shared/zod`.

### Доступ
- Только роль `organizer`.

### Пример тела

```json
{
  "title": "Субботник",
  "description": "Помогаем парку",
  "activityType": "Экология",
  "eventDate": "2025-02-10T00:00:00.000Z",
  "startDateTime": "2025-02-10T07:00:00.000Z",
  "endDateTime": "2025-02-10T11:00:00.000Z",
  "location": "Парк Победы",
  "address": "ул. Зеленая, 5",
  "maxParticipants": 30,
  "requirements": "Одежда по погоде",
  "skillsNeeded": ["Работа в команде"]
}
```

### Ответы
- `201` — `{ "success": true, "data": { "id": "uuid" } }`
- `400` — ошибка валидации.
- `401`/`403` — недостаточно прав.
- `500` — внутренняя ошибка.

## GET /api/events/[eventId]

### Назначение
Получение полной информации о мероприятии: базовые данные, ёмкость, агрегаты заявок и волонтёрских часов.

### Доступ
- `organizer`: только свои мероприятия.
- `volunteer`: только публичные статусы (`published`, `active`, `completed`).

### Ответ
Структура идентична объекту из массива `data` в `GET /api/events`.

### Ошибки
- `401` — не авторизован.
- `403` — нет прав на просмотр.
- `404` — мероприятие не найдено.
- `500` — внутренняя ошибка.

## PATCH /api/events/[eventId]

### Назначение
Частичное обновление мероприятия. Принимает любые поля из `eventCreateSchema` плюс `status`.

### Доступ
- Только `organizer` и только для своих мероприятий.

### Особенности
- При обновлении `startDateTime` и `endDateTime` поле `requiredHours` пересчитывается автоматически.
- Пустое тело отклоняется с ошибкой `400`.

### Ответы
- `200` — `{ "success": true, "data": { "id": "uuid" } }`
- `400` — некорректные данные.
- `403`/`404` — нет прав или запись отсутствует.
- `500` — внутренняя ошибка.

## DELETE /api/events/[eventId]

### Назначение
Удаление мероприятия из базы.

### Доступ
- Только `organizer` и только для своих мероприятий.

### Ответы
- `200` — `{ "success": true }`
- `403`/`404` — нет прав или запись не найдена.
- `500` — внутренняя ошибка.

## POST /api/events/[eventId]/register

### Назначение
Регистрация волонтёра на мероприятие (создание или повторная активация заявки).

### Доступ
- Только роль `volunteer`.
- Разрешено записываться, если статус мероприятия `published` или `active`.

### Тело

```json
{
  "motivationLetter": "Хочу помочь городу"
}
```

Поле опциональное, максимум 2000 символов.

### Ответы
- `201` — заявка создана.
- `200` — восстановлена ранее отменённая заявка.
- `400` — ошибка валидации письма.
- `403` — регистрация запрещена для текущего статуса.
- `404` — мероприятие не найдено.
- `409` — достигнут лимит или пользователь уже записан.
- `500` — внутренняя ошибка.
